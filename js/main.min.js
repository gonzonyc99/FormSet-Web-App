function getOffset(e) {
    var t = 0;
    var n = 0;
    while (e && !isNaN(e.offsetLeft) && !isNaN(e.offsetTop)) {
        t += e.offsetLeft - e.scrollLeft;
        n += e.offsetTop - e.scrollTop;
        e = e.offsetParent
    }
    return {
        top: n,
        left: t
    }
}

function insertHTMLString() {
    for (var e = 0; e < MODELS.length; e++) {
        var t = document.createElement("div");
        $(t).addClass("model-item");
        t.id = MODELS[e].id;
        var n = document.createElement("div");
        $(n).addClass("model-item-title");
        $(n).html("<span>" + MODELS[e].title + "</span>");
        var r = document.createElement("div");
        $(r).addClass("model-item-content");
        var i = "";
        for (var s = 0; s < MODELS[e].item.length; s++) {
            var o = MODELS[e].item[s];
            i += '<img src="' + o.image + '" id="' + o.id + '" />'
        }
        if (t.id == "FinalTouches") {
            i += "<button>Custom Touches</button>"
        }
        $(r).html(i);
        t.appendChild(n);
        t.appendChild(r);
        document.getElementById("model-container").appendChild(t);
    }
    $(".model-item-content").toggle();
    var u = "";
    for (var e = 6; e <= 20; e += 2) {
        u += '<option value="' + e + '">' + e + "</option>"
    }
    $("#wall-content .heigh-text").html(u);
    //8_22_Stage_Ag_notes.xls - #15
    u = '<option value=" "> </option>';
    for (var e = 1; e <= 4; e += 1) {
        u += '<option value="' + e + '">' + e + "</option>"
    }
    $("#stage-content .heigh-text").html(u);
    u = "";
    //8_22_Stage_Ag_notes.xls - #15
    for (var e = 4; e <= 80; e += 2) {
        u += '<option value="' + e + '">' + e + "</option>"
    }
    $("#wall-content .weight-text").html(u);
    u = '<option value=" "> </option>' + u;
    $("#stage-content .weight-text").html(u)
}

function setWindowStyle() {
    var e = window.innerWidth;
    var t = window.innerHeight;
    $("#tab-title").css({
        width: e - 120 + "px"
    });
    $("#tab-container").css({
        height: t - 120 + "px"
    });
    $("#preview-content").css({
        width: e - 180 + "px",
        height: t - 80 + "px"
    });
    $("#preview-window-buttons").css({
        width: "80px",
        height: t - 80 + "px",
        "margin-top": "40px"
    });
    $("#upload-button").css({
        "margin-top": t - 250 + "px"
    });
    $("#close-button").css({
        "margin-top": "10px"
    });
    setCreateTabStyle(e, t);
    setDesignTabStyle(e, t);
    setExportTabStyle(e, t)
}

function setCreateTabStyle(e, t) {
    var n = t - (130 + 70);
    $("#wall-content").css({
        height: n / 2 + "px"
    });
    $("#stage-content").css({
        height: n / 2 + "px"
    })
}

function setDesignTabStyle(e, t) {
    var n = t - 130;
    var r = e - 250;
    $(".main-container").css({
        height: n + "px"
    });
    $("#eidt-container").css({
        width: r + "px"
    });
    $("#edit-board").css({
        height: n - 75 + "px"
    });
    $("#design-stage").css({
        width: r - 40 + "px",
        height: n - 115 + "px"
    });
    var i = 1 + $("#zoom-control").val() / 100;
    i = 1;
    DesignW = (r - 40) * i;
    DesignH = (n - 115) * i;
    var s = document.getElementsByTagName("canvas")[0];
    s.width = DesignW;
    s.height = DesignH;
    s = $("#preview-stage")[0];
    s.width = e - 180;
    s.height = t - 80;
    if (FormDesign) {
        FormDesign.resizeProc(DesignW, DesignH, e - 180, t - 80)
    }
}

function setExportTabStyle(e, t) {
    $(".export-board").css({
        height: t - 200 + "px"
    })
}

function resizeEvent() {
    setWindowStyle()
}

function initEvents() {
    var e = "click";
    if (isMobile.any()) e = "touchstart";
    $(".tab-menu").on(e, function() {
        var e = this.id;
        switch (e) {
            case "tab-menu-create":
                $(".tab-menu .selected").removeClass("selected");
                $(this).find(".select-bar").addClass("selected");
                $("#tab-container .tab-item").hide();
                $("#create-content").show();
                break;
            case "tab-menu-design":
                if (FormDesign && FormDesign._sRow != 0) {
                    $(".tab-menu .selected").removeClass("selected");
                    $(this).find(".select-bar").addClass("selected");
                    $("#tab-container .tab-item").hide();
                    $("#design-content").show()
                }
                break;
            case "tab-menu-export":
                if (FormDesign && FormDesign._sRow != 0) {
                    $(".tab-menu .selected").removeClass("selected");
                    $(this).find(".select-bar").addClass("selected");
                    $("#tab-container .tab-item").hide();
                    $("#export-content").show()
                }
                break
        }
    });
    $(".model-item-title").on(e, function() {
        if ($(this).hasClass("selected")) {
            $(".model-item-title.selected").removeClass("selected");
            $(this).parent().find(".model-item-content").animate({
                height: "toggle"
            }, 300, function() {});
            return
        }
        $(".model-item-title.selected").parent().find(".model-item-content").animate({
            height: "toggle"
        }, 300, function() {});
        $(".model-item-title.selected").removeClass("selected");
        $(this).addClass("selected");
        $(this).parent().find(".model-item-content").animate({
            height: "toggle"
        }, 300, function() {})
    });
    $("#submit-button").on(e, function() {
        var e = $("#wall-content .heigh-text");
        var t = parseInt($("#wall-content .heigh-text").val());
        var n = parseInt($("#wall-content .weight-text").val());
        var r = parseInt($("#stage-content .heigh-text").val());
        var i = parseInt($("#stage-content .weight-text").val());
        if (t <= 0 || n <= 0) return;
        if (t % 2 != 0 || n % 2 != 0) return;
        FormDesign.setRowAndCol(n, t, i, r);
        $(".tab-menu .selected").removeClass("selected");
        $("#tab-menu-design").find(".select-bar").addClass("selected");
        $("#tab-container .tab-item").hide();
        $("#design-content").show();
        $("#mask-container").show();
        $("#design-instruction").show();
    });
    var t = "mousedown";
    var n = "mouseup";
    if (isMobile.any()) {
        t = "touchstart";
        n = "touchend"
    }
    $("body").delegate(".model-item-content img", t, function() {
        if (DragObject) {
            $(DragObject).remove();
            DragObject = null
        }
        var e = $(this).clone();
        $(this).before(e);
        e.draggable({
            drag: function(e, t) {
                var n = getSnapProc(e.clientX, e.clientY - 10);
                t.position.left = n.left;
                t.position.top = n.top
            }
        });
        var t = getOffset(e[0]);
        $(this).css({
            position: "absolute",
            left: t.left + "px",
            top: t.top + "px",
            "margin-left": "0px",
            width: FormDesign._unitSize + "px",
            height: FormDesign._unitSize + "px",
            "z-index": 9999
        });
        DragObject = this;
        return true
    });
    $("body").delegate(".model-item-content img", n, function() {
        if (DragObject) {
            mouseUpProc(DragObject);
            $(DragObject).remove();
            DragObject = null
        }
        return true
    });
    $(".model-item-content img").draggable({
        drag: function(e, t) {
            var n = getSnapProc(e.clientX, e.clientY - 10);
            t.position.left = n.left;
            t.position.top = n.top
        }
    });
    $("#delete-mark").on(e, function() {
        var e = confirm("Press a button");
        if (e == true) {
            FormDesign.deleteAllItemsObject()
        }
    });
    $("#color-box").colpick({
        colorScheme: "dark",
        layout: "rgbhex",
        color: "ffffff",
        onSubmit: function(e, t, n, r) {
            $(r).css("background-color", "#" + t);
            $(r).colpickHide();
            FormDesign.changeColor("#" + t)
        }
    }).css("background-color", "#dddddd");
    $("#zoom-control").on("change", function() {
        var e = 1 + $(this).val() / 100;
        //e = 1;
        var t = window.innerHeight - 130;
        var n = window.innerWidth - 250;
        DesignW = (n - 40) * e;
        DesignH = (t - 115) * e;
        var r = document.getElementsByTagName("canvas")[0];
        r.width = DesignW;
        r.height = DesignH;
        if (FormDesign) {
            FormDesign.resizeProc(DesignW, DesignH)
        }
    });
    $("#close-button").on(e, function() {
        $("#mask-container").hide();
        $("#preview-container").hide()
    });
    $("#preview-mark").on(e, function() {
        FormDesign.drawPreview();
        $("#mask-container").show();
        $("#preview-container").show()
    });
    $("#export-type .export-sub-item").on(e, function() {
        $("#export-type .selected").removeClass("selected");
        $(this).find(".width-mark").addClass("selected")
    });
    $("#export-size .export-sub-item").on(e, function() {
        $("#export-size .selected").removeClass("selected");
        $(this).find(".width-mark").addClass("selected")
    });
    $("#export-button").on(e, function() {
        var e;
        if ($("#export-type .selected").parent()[0].id == "export-jpg") e = "jpg";
        else e = "png";
        var t;
        if ($("#export-size .selected").parent()[0].id == "export-small") t = "small";
        else if ($("#export-size .selected").parent()[0].id == "export-medium") t = "medium";
        else t = "large";
        FormDesign.exportProc(e, t)
        
        //image = image.replace('data:image/png;base64,', '');
        $("#img_data").val(FormDesign._imgData);
        //$("#user-detail").trigger("submit");
    });
    $("#upload-button").on(e, function() {
        uploadID = "upload-button";
        document.getElementById("image-files").click()
    });
    $(".model-item .model-item-content button").on(e, function() {
        uploadID = "custom-button";
        document.getElementById("image-files").click()
    });
    $("#instruction-button").on(e, function() {
        $("#mask-container1").hide();
        $("#instruction").hide()
    });
    $("#design-instruction-button").on(e, function() {
        $("#mask-container").hide();
        $("#design-instruction").hide()
    });
    
    //8_22_Stage_Ag_notes.xls - #6
    $("input[name=stage-chkbox]").on("change", function(){
    	FormDesign._bDrawStage = $(this).prop("checked");
    });
    
    /*$(".chkbox").toggle(function() {
    	alert("eeee")
  		$(this).css("backgroundPosition", "0 -29px");
	}, function() {
		alert("qqqqqqq")
		$(this).css("backgroundPosition", "0 0");
	});
    $(".chkbox").show();*/
   
   	$(".chkbox").on('click', function(){
		if($(this).css("backgroundPosition") == "0px -30px"){
			$(this).css("backgroundPosition", "0 0");
			FormDesign._bDrawStage = true;
		} else {
			$(this).css("backgroundPosition", "0 -30px");
			FormDesign._bDrawStage = false;
		}  		
   	});	
    
    $(".datepicker").datepicker();
    document.getElementById("image-files").addEventListener("change", handleFileSelect, false)
}

function detectVerticalSquash(e) {
    var t = e.naturalWidth,
        n = e.naturalHeight;
    var r = document.createElement("canvas");
    r.width = 1;
    r.height = n;
    var i = r.getContext("2d");
    i.drawImage(e, 0, 0);
    var s = i.getImageData(0, 0, 1, n).data;
    var o = 0;
    var u = n;
    var a = n;
    while (a > o) {
        var f = s[(a - 1) * 4 + 3];
        if (f === 0) {
            u = a
        } else {
            o = a
        }
        a = u + o >> 1
    }
    var l = a / n;
    return l === 0 ? 1 : l
}

function drawImageIOSFix(e, t, n, r, i, s, o, u, a, f) {
    var l = detectVerticalSquash(t);
    e.drawImage(t, n * l, r * l, i * l, s * l, o, u, a, f)
}

function handleFileSelect(e) {
    $("#mask-container1").show();
    $("#wait-container").show();
    var t = e.target.files[0];
    if (!t.type.match("image.*")) return false;
    const n = t.name.split(".").pop();
    var r = new FileReader;
    r.onload = function(e) {
        return function(e) {
            var t = new Image;
            t.onload = function() {
                var e = 600,
                    r = 600,
                    i = t.width,
                    s = t.height;
                if (i > s) {
                    if (i > e) {
                        s *= e / i;
                        i = e
                    }
                } else {
                    if (s > r) {
                        i *= r / s;
                        s = r
                    }
                }
                var o = document.createElement("canvas");
                o.width = i;
                o.height = s;
                var u = o.getContext("2d");
                drawImageIOSFix(u, this, 0, 0, this.width, this.height, 0, 0, i, s);
                var a = o.toDataURL(n);
                document.getElementById("form1_data1").value = a;
                document.getElementById("form1_data2").value = "." + n;
                var f = new FormData(document.forms["form1"]);
                var l = new XMLHttpRequest;
                l.open("POST", "upload.php", true);
                l.upload.onprogress = function(e) {
                    if (e.lengthComputable) {
                        var t = e.loaded / e.total * 100;
                        console.log(parseInt(t) + "% uploaded")
                    }
                };
                l.onload = function() {};
                l.onreadystatechange = function() {
                    if (l.readyState == 4) {
                        $("#mask-container1").hide();
                        $("#wait-container").hide();
                        var e = l.responseText;
                        FormDesign.addUploadedImage(e, uploadID)
                    }
                };
                l.send(f)
            };
            t.src = e.target.result
        }
    }(t);
    r.readAsDataURL(t);
    document.getElementById("image-files").value = "";
    return
}

function getCanvasPos() {
    var e = getOffset($("#design-stage")[0]);
    return e
}

function getSnapProc(e, t) {
    var n = getCanvasPos();
    var r = n.left + FormDesign._left + 1;
    var i = n.top + FormDesign._top - 10;
    if (e < r || e > r + FormDesign._unitSize * FormDesign._wRow || t < i || t > i + FormDesign._unitSize * FormDesign._wCol) {
        return {
            left: e - FormDesign._unitSize / 2,
            top: t - FormDesign._unitSize / 2
        }
    }
    for (var s = 0; s < FormDesign._wRow; s++) {
        for (var o = 0; o < FormDesign._wCol; o++) {
            var u = r + FormDesign._unitSize * s;
            var a = i + FormDesign._unitSize * o;
            if (e >= u && e < u + FormDesign._unitSize && t >= a && t < a + FormDesign._unitSize) return {
                left: u,
                top: a
            }
        }
    }
    return {
        left: e,
        top: t
    }
}

function mouseUpProc(e) {
    var t = getCanvasPos();
    var n = DragObject.x + 1 + FormDesign._unitSize / 2 - t.left;
    var r = DragObject.y - 10 + FormDesign._unitSize / 2 - t.top;
    FormDesign.addObjectProc(e, n, r)
}
var FormDesign = null;
var DragObject = null;
var DesignW = 100,
    DesignH = 100;
var uploadID = "";
window.onresize = resizeEvent;
window.onload = resizeEvent;
var isMobile = {
    Android: function() {
        return navigator.userAgent.match(/Android/i)
    },
    BlackBerry: function() {
        return navigator.userAgent.match(/BlackBerry/i)
    },
    iOS: function() {
        return navigator.userAgent.match(/iPhone|iPad|iPod/i)
    },
    Opera: function() {
        return navigator.userAgent.match(/Opera Mini/i)
    },
    Windows: function() {
        return navigator.userAgent.match(/IEMobile/i)
    },
    any: function() {
        return isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows()
    }
};
jQuery(document).ready(function(e) {
    e("#mask-container").hide();
    e("#preview-container").hide();
    e("#wait-container").hide();
    insertHTMLString();
    setWindowStyle();
    initEvents();
    e("#create-content").show();
    FormDesign = new FORMSETDESIGN(DesignW, DesignH)
})